
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Segmentation and modeling tutorial for U Michigan">
      
      
        <meta name="author" content="baradlab">
      
      
        <link rel="canonical" href="https://baradlab.com/michigan_tutorial/dragonfly/">
      
      
        <link rel="prev" href="../membrain-seg/">
      
      
        <link rel="next" href="../morphometrics/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.26">
    
    
      
        <title>Dragonfly Segmentation - baradlab/michigan_tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#launch-dragonfly" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="baradlab/michigan_tutorial" class="md-header__button md-logo" aria-label="baradlab/michigan_tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9M12 4.15 6.04 7.5 12 10.85l5.96-3.35L12 4.15M5 15.91l6 3.38v-6.71L5 9.21v6.7m14 0v-6.7l-6 3.37v6.71l6-3.38Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            baradlab/michigan_tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dragonfly Segmentation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: slate)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/baradlab/michigan_tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    baradlab/michigan_tutorial
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="baradlab/michigan_tutorial" class="md-nav__button md-logo" aria-label="baradlab/michigan_tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18-.21 0-.41-.06-.57-.18l-7.9-4.44A.991.991 0 0 1 3 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18.21 0 .41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9M12 4.15 6.04 7.5 12 10.85l5.96-3.35L12 4.15M5 15.91l6 3.38v-6.71L5 9.21v6.7m14 0v-6.7l-6 3.37v6.71l6-3.38Z"/></svg>

    </a>
    baradlab/michigan_tutorial
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/baradlab/michigan_tutorial" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    baradlab/michigan_tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Steps
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../membrain-seg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Membrain-Seg Segmentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Dragonfly Segmentation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Dragonfly Segmentation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#launch-dragonfly" class="md-nav__link">
    <span class="md-ellipsis">
      Launch Dragonfly
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-dragonfly" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up Dragonfly
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-the-denoising-model" class="md-nav__link">
    <span class="md-ellipsis">
      Loading the Denoising Model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-the-data-and-the-membrain-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Loading the Data and the Membrain Segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calibrating-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Calibrating the Data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preprocessing-the-image" class="md-nav__link">
    <span class="md-ellipsis">
      Preprocessing the Image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-to-train-the-neural-network" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing to train the Neural Network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-a-new-neural-network" class="md-nav__link">
    <span class="md-ellipsis">
      Training a new neural network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-neural-net-and-retraining" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluating the neural net and retraining
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-trained-data" class="md-nav__link">
    <span class="md-ellipsis">
      Extracting Trained Data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../morphometrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Surface Morphometrics
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#launch-dragonfly" class="md-nav__link">
    <span class="md-ellipsis">
      Launch Dragonfly
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-dragonfly" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up Dragonfly
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-the-denoising-model" class="md-nav__link">
    <span class="md-ellipsis">
      Loading the Denoising Model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loading-the-data-and-the-membrain-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      Loading the Data and the Membrain Segmentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calibrating-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Calibrating the Data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preprocessing-the-image" class="md-nav__link">
    <span class="md-ellipsis">
      Preprocessing the Image
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-to-train-the-neural-network" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing to train the Neural Network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-a-new-neural-network" class="md-nav__link">
    <span class="md-ellipsis">
      Training a new neural network
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-neural-net-and-retraining" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluating the neural net and retraining
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extracting-trained-data" class="md-nav__link">
    <span class="md-ellipsis">
      Extracting Trained Data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Dragonfly Segmentation</h1>

<p>Dragonfly is a free-for-nonprofit software package that has a nice set of tools for generating training data, training a variety of different neural networks types, and applying them flexibly to different kinds of data. Jess Heebner in Matt Swulius's lab developed some excellent protocols for using matlab to segment tomography data, and showed that in high-contrast examples it is possible to differentiate actin from cofilactin, for example. They also established a simplified protocol for extracting filaments in amira from segmentations, massively reducing the human time required for that kind of analysis. Their jove article detailing this protocol can be found here: https://www.jove.com/t/64435/deep-learning-based-segmentation-of-cryo-electron-tomograms. What we are going to do today is a slight update from their original protocols, but ultimately you can't go wrong following their jove article. The only exception would be that I would advise not using the segmentation wizard, and instead using the deep learning toolbox. That is what we will do today!</p>
<h2 id="launch-dragonfly">Launch Dragonfly</h2>
<p>Hopefully this is already done if you licensed everything and it went well!</p>
<div class="highlight"><pre><span></span><code>module<span class="w"> </span>load<span class="w"> </span>dragonfly
Dragonfly
</code></pre></div>
<p>We will pause here for everyone to get set up with Dragonfly. If you have any issues, please let one of us know! Sometimes Dragonfly stalls when you launch it - if this happens, open a new tab and try launching dragonfly again. That should unstall the first one and you can kill the second job once it does (with Ctrl-C). Yes, I also hear how crazy that sounds as a strategy.</p>
<h2 id="setting-up-dragonfly">Setting up Dragonfly</h2>
<p>Hopefully you all got Dragonfly licensed and opened earlier today. If you haven't, please do so now. If you have any issues, please let me know. </p>
<p>Within dragonfly, we want to make one settings change to make life easier:
1. Go to File -&gt; Preferences
3. Change "Default Unit" to "nanometers" - most people do segmentations in nm scale, because that is what the volume EM community uses. The features we care about are usually 5+ nm in scale so this is a good default. All the software we are using will work fine in Angstrom scale, however.</p>
<p>The software is a bit liable to crashing - to account for this, I'd recommend setting up autosave in File -&gt; Preferences -&gt; Autosave. I'd recommend saving every 5 minutes, and keeping 3 backups. This will save you a lot of headache if the software crashes.</p>
<p>I anticipate this will take a bit of time to get everyone set up for everyone (licensing in particular) so if you get through quickly, feel free to grab a coffee!</p>
<h2 id="loading-the-denoising-model">Loading the Denoising Model</h2>
<p>The first thing we are going to do is load a denoising model. This is a neural network that has been trained to remove noise from tomography data. This is not at all a critical step in the process, but it can make the hand segmentation process a little easier. We made this denoising model using Matt Swulius's <a href="https://doi.org/10.1101/2023.04.28.538636">CryoTomoSim</a> software to generate noise free and noisy simulated data with lots of membranes, filaments, and other bits and bobs. It is not quite as accurate as cryoCARE or isonet, but it is fast and easy.</p>
<p>To load the denoising model, go to the "Deep Learning" tab, and click "Load Model". Navigate to <code>/scratch/segmentation_dataset</code> and select the whole <code>tutorial</code> folder. This will load the denoising model, but you won't actually run it through the denoising tool (you can, but we won't today).</p>
<h2 id="loading-the-data-and-the-membrain-segmentation">Loading the Data and the Membrain Segmentation</h2>
<p>Next, we are going to load the data. File -&gt; Open -&gt; navigate to <code>/scratch/segmentation_dataset</code> and select the <code>TE3_tomo.mrc</code> file. This is a tomogram showing a mitochondrion with some filaments in it. You should have gotten membrane segmentations of this data from the previous tutorial. If you haven't, you can find a usable segmentation in <code>/scratch/segmentation_dataset/morpho_run/datadir</code>. Load that file with the same File -&gt; Open process.</p>
<h2 id="calibrating-the-data">Calibrating the Data</h2>
<p>Calibration puts all the data on a similar intensity scale. 
1. Check on the mode and standard deviation of the intensities in the data. On the data panel on the right side of the screen, with the tomogram selected, click on the histogram button under tools.
2. Note down the mode and standard deviation of the data. Calculate the mode - standard deviation.
3. Right click on the dataset and select Calibrate Intensity Scale. Set the foreground label to the mode and the background label to the mode - standard deviation. This will put the data on a consistent intensity scale.</p>
<h2 id="preprocessing-the-image">Preprocessing the Image</h2>
<ol>
<li>Workflows -&gt; Image Filtering</li>
<li>Select "Histogram Equalization". Deselect the output.</li>
<li>Click add and then select "Gaussian". Deselect the output.</li>
<li>Click add and then select "Unsharp". Leave the output.</li>
<li>Click "Apply" to apply the filter.</li>
</ol>
<p>This is where you can try out the denoiser in addition to the other "standard" processing steps. Instead of or in addition to doing the above steps, you can filter with AI:
1. Main -&gt; Filter with AI
2. Select the denoising model you loaded earlier.
3. Click "Filter" to apply the filter.</p>
<h2 id="preparing-to-train-the-neural-network">Preparing to train the Neural Network</h2>
<ol>
<li>Convert the membrane segmentation to a multi-ROI by right-clicking on the segmentation and selecting "Extract ROIs". </li>
<li>Delete the background ROI by clicking and trashing.</li>
<li>Select the other ROI and right-click to "Create Multi-ROI from ROI". This will create a multi-ROI with the membrane pre-segmented.</li>
<li>Add the following classes to the multi-ROI: "Actin", "Septin", "Microtubule", "Ribosome", "Background"</li>
<li>Right click on the objects panel and select "Create a box from" and select current box. Choose to make the box 400 by 400 by 32 pixels.</li>
<li>Move the box to a place where you can see some of each class of object. The 4-panel view can help with this.</li>
<li>Switch to the segment panel and select the ROI painter -&gt; round brush, and select the OTSU brush. This will allow you to paint in the different classes of objects quickly and efficiently (if your calibration is good!)</li>
<li>Start painting! Ctrl-left click to paint in the different classes of objects, and shift-left click to erase.</li>
<li>Once you are done, </li>
<li>Once you are done, right click on the box and select "Add to ROI", "New ROI", name it "Mask".</li>
</ol>
<h2 id="training-a-new-neural-network">Training a new neural network</h2>
<ol>
<li>AI -&gt; Deep Learning Tool</li>
<li>New Model</li>
<li>"U-Net", "Semantic Segmentation", 6 classes (or 5 if you skipped ribosomes), 2.5D, 3 or 5 layers. More layers helps a lot but takes longer to train. </li>
<li>Set up deep learning with that tool.</li>
<li>Select the input data as input, the multi-ROI as output, and the mask as mask.</li>
<li>Adjust the augmentation to have 2x augmentation. More is better, but we want to go fast not good today.</li>
<li>Select visual feedback and select the input data.</li>
<li>Adjust the training parameters:<ul>
<li>Lower the epoch number. 25 is a good number that will go quick but not be low-quality.</li>
<li>Increase batch size until the GPU memory is ~60% full.</li>
</ul>
</li>
<li>Click "Train"</li>
</ol>
<p><strong>Coffee break!!!</strong></p>
<h2 id="evaluating-the-neural-net-and-retraining">Evaluating the neural net and retraining</h2>
<p>Once the neural network is trained, you can apply it to the data and see how well it does. If it doesn't do well, you can continue to retrain it using the OTSU brush. At OHSU, we generally do 1 round of training with a pretrained network, then spend a bit of time repainting, then do a second round of training. This generally allows us to get a good to great segmentation with under an hour of human time.
1. Segment Panel -&gt; Segment with AI
2. Select the neural network you just trained.
3. Click "Segment" (or "Preview" if you only want to see one slice)
Optional: If the segmentation is bad, you can retrain the network with the new data.
4. Use the otsu brush to correct any mistakes. You can also use the "Fill" tool to move large areas to background if needed.
5. Repeat the training process once the correction is done. You might want to use a new box/mask to cover a relatively small number of larger slices - maybe 1k by 1k by 32 so you just clean up part of the data then train.</p>
<h2 id="extracting-trained-data">Extracting Trained Data</h2>
<p>Once you have an inferred segmentation, you can extract the data as tifs then convert them to mrc. This is a bit of a pain, and ORS has a beta version of direct MRC export, so expect this to be much better in the future!
1. Right click on the segmentation and select "Convert to Greyscale"
2. Right click on the greyscale and select "Export" and select "TIF". Choose somewhere to save the data.
3. Convert the stack of TIFs to MRC using IMOD.
<div class="highlight"><pre><span></span><code>module<span class="w"> </span>load<span class="w"> </span>imod
<span class="nb">cd</span><span class="w"> </span>&lt;wherever<span class="w"> </span>you<span class="w"> </span>saved<span class="w"> </span>the<span class="w"> </span>tif<span class="w"> </span>files&gt;
tif2mrc<span class="w"> </span>*.tif<span class="w"> </span>TE3_dragonfly_labels.mrc
3dmod<span class="w"> </span>TE3_dragonfly_labels.mrc
</code></pre></div></p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 baradlab
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.expand", "search.highlight", "search.suggest", "content.tabs.link"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>